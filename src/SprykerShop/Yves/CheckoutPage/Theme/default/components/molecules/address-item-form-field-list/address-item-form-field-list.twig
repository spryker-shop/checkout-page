{% extends model('component') %}

{% define config = {
    name: 'address-item-form-field-list'
} %}

{% define data = {
    items: required
} %}

{% block body %}
    <div class="grid grid--middle">
        {% for item in data.items %}
            {% set itemName = item.vars.data.name | default %}
            {% set itemQuantity = item.vars.data.quantity | default %}
            {% set imageUrl = item.vars.data.images is not empty ? item.vars.data.images[0].externalUrlSmall : '' %}
            {% set hiddenClass = '' %}

            <div class="col col--sm-1 spacing spacing--inner">
                {% include atom('thumbnail') with {
                    modifiers: ['small'],
                    attributes: {
                        alt: itemName,
                        src: imageUrl,
                        title: itemName
                    }
                } only %}
            </div>

            <div class="col col--sm-2 spacing spacing--inner">
                <p><strong>{{ itemName }}</strong></p>
                <p>{{ ('customer.order.item_quantity' | trans) }}: {{ itemQuantity }}</p>
            </div>

            {% if item.shippingAddress.id_customer_address is defined %}
                <div class="col col--sm-3 spacing spacing--inner">
                    {{ form_widget(item.shippingAddress.id_customer_address, {
                        attr: {
                            'form-target-selector': '',
                            'class': 'js-validate-next-checkout-step__trigger',
                        },
                    }) }}
                </div>
                {% set hiddenClass = 'is-hidden' %}
            {% endif %}

            {% include molecule('validate-next-checkout-step', 'CheckoutPage') with {
                attributes: {
                    'form-selector': '',
                    'trigger-selector': '',
                    'target-selector': '',
                },
            } only %}

            <div class="col col--sm-12">
                {% embed molecule('form') with {
                    class: 'js-address__item-shipping ' ~ hiddenClass ~ ' js-address__item-shipping--' ~ loop.index,
                    data: {
                        form: item.shippingAddress,
                        enableStart: false,
                        enableEnd: false,
                        layout: {
                            salutation: 'col col--sm-12 col--lg-2',
                            first_name: 'col col--sm-12 col--lg-5',
                            last_name: 'col col--sm-12 col--lg-5',
                            address1: 'col col--sm-12 col--md-8 col--lg-10',
                            address2: 'col col--sm-12 col--md-4 col--lg-2',
                            zip_code: 'col col--sm-6 col--lg-4',
                            city: 'col col--sm-6 col--lg-4',
                            iso2_code: 'col col--sm-12 col--lg-4'
                        }
                    }
                } only %}
                    {% block field %}
                        {{ form_row(field, {
                            attr: {
                                'data-key': field.vars.name
                            },
                            rowAttr: {
                                class: config.name ~ '__field ' ~ fieldLayoutClass
                            }
                        }) }}
                    {% endblock %}
                {% endembed %}

                {% if item.shippingAddress.id_customer_address is defined %}
                    {% include molecule('address-form-toggler', 'CustomerPage') ignore missing with {
                        attributes: {
                            'trigger-selector': '[name="' ~ item.shippingAddress.id_customer_address.vars.full_name ~ '"]' | default(''),
                            'target-selector': '.js-address__item-shipping--' ~ loop.index,
                            'class-to-toggle': 'is-hidden'
                        }
                    } only %}
                {% endif %}

                {% if item.isAddressSavingSkipped is defined %}
                    {% include molecule('save-new-address', 'CustomerPage') ignore missing with {
                        class: 'spacing is-hidden',
                        data: {
                            form: item
                        },
                        attributes: {
                            'shipping-address-toggler-selector': item.shippingAddress.id_customer_address is defined ? '[name="' ~ item.shippingAddress.id_customer_address.vars.full_name ~ '"]' : '',
                            'save-address-toggler-selector': '[name="' ~ item.isAddressSavingSkipped.vars.full_name ~ '"]'
                        }
                    } only %}
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% endblock %}
